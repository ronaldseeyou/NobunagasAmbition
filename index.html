<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8"/>
<title>ä¿¡é•·ä¹‹é‡æœ› æˆ°ç¸¾ç¶²</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --acc:#94a3b8;--acc2:#64748b;--win:#4ade80;--lose:#f87171;--gold:#fbbf24;
  --card:rgba(15,20,35,0.9);--bdr:rgba(148,163,184,0.1);
  --bg:radial-gradient(circle at top,#0d1117,#020408);
  --text:#e2e8f0;--sub:#64748b;--dim:#1e293b;
}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);min-height:100vh;color:var(--text);overflow-x:hidden}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .35s ease both}

/* HEADER */
#header{position:sticky;top:0;z-index:50;background:rgba(2,4,8,0.97);backdrop-filter:blur(18px);border-bottom:1px solid var(--bdr);box-shadow:0 2px 20px rgba(0,0,0,.8)}
#header-inner{max-width:900px;margin:0 auto;padding:12px 16px 0}
.brand-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
#castle-icon{width:44px;height:44px;flex-shrink:0;border-radius:10px;overflow:hidden;border:1.5px solid rgba(148,163,184,.25);box-shadow:0 0 16px rgba(148,163,184,.08)}
#castle-icon img{width:100%;height:100%;object-fit:cover}
.brand-title{font-size:18px;font-weight:800;color:#e2e8f0;letter-spacing:1px;line-height:1.2}
.brand-sub{font-size:10px;color:#334155;letter-spacing:.8px;margin-top:2px}
#live-badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;flex-shrink:0}
.tabs{display:flex;overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab-btn{padding:8px 18px;background:transparent;color:#334155;border:none;border-bottom:2px solid transparent;cursor:pointer;font-size:13px;font-weight:600;font-family:inherit;transition:all .2s;white-space:nowrap}
.tab-btn.active{color:#94a3b8;border-bottom-color:#64748b}

/* LAYOUT */
#app{max-width:900px;margin:0 auto;padding:16px 14px 60px}
.tab-pane{display:none}.tab-pane.active{display:block}
.sec-bar{display:flex;align-items:center;gap:10px;margin:20px 0 12px;padding-left:12px;position:relative}
.sec-bar::before{content:'';position:absolute;left:0;top:10%;bottom:10%;width:3px;background:var(--sub);border-radius:2px}
.sec-bar span{font-size:15px;font-weight:700;color:#cbd5e1;letter-spacing:.3px}
.card{background:var(--card);backdrop-filter:blur(14px);border:1px solid var(--bdr);border-radius:13px;padding:16px 18px;margin-bottom:18px}

/* FACTION */
.fac-nums{display:flex;justify-content:space-between;margin-bottom:12px}
.fac-big{font-size:34px;font-weight:800;line-height:1}
.fac-lbl{font-size:11px;color:var(--sub);margin-top:4px}
.fac-track{height:7px;border-radius:4px;overflow:hidden;background:rgba(0,0,0,.4);display:flex}
.fac-seg{height:100%;transition:width 1.2s cubic-bezier(.4,0,.2,1)}

/* PLAYER TABLE */
.ptable-wrap{background:var(--card);border:1px solid var(--bdr);border-radius:13px;backdrop-filter:blur(14px);overflow:hidden;margin-bottom:8px}
.ptable-head{padding:10px 14px;background:rgba(5,8,15,.95);border-bottom:1px solid var(--bdr);display:grid;grid-template-columns:24px 1fr 90px 36px 68px;gap:6px;font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:.8px;font-weight:700}
.prow-wrap{border-bottom:1px solid rgba(148,163,184,.04);cursor:pointer;transition:background .15s;border-left:3px solid transparent;display:grid;grid-template-columns:24px 1fr 90px 36px 68px;gap:6px;align-items:center;padding:11px 12px}
.prow-wrap:hover{background:rgba(148,163,184,.03)}
.prow-wrap.open{background:rgba(148,163,184,.04);border-left-color:#475569}
.prow-wrap.last-win{border-left-color:rgba(74,222,128,.3)}
.prow-wrap.last-lose{border-left-color:rgba(248,113,113,.2)}
.hero-expand-row{overflow:hidden;background:rgba(3,5,10,.95);border-bottom:1px solid rgba(148,163,184,.03)}

/* BADGES */
.badge{font-size:9px;padding:1px 5px;border-radius:6px;font-weight:700;display:inline-block;margin-left:4px;vertical-align:middle;white-space:nowrap}
.badge-win{background:rgba(74,222,128,.07);color:#4ade80;border:1px solid rgba(74,222,128,.18)}
.badge-lose{background:rgba(248,113,113,.07);color:#f87171;border:1px solid rgba(248,113,113,.18)}
.badge-gold{background:rgba(251,191,36,.07);color:#fbbf24;border:1px solid rgba(251,191,36,.18)}
.badge-grey{background:rgba(100,116,139,.07);color:#64748b;border:1px solid rgba(100,116,139,.18)}
.badge-blue{background:rgba(148,163,184,.07);color:#94a3b8;border:1px solid rgba(148,163,184,.18)}
.badge-purple{background:rgba(167,139,250,.07);color:#a78bfa;border:1px solid rgba(167,139,250,.18)}
.badge-teal{background:rgba(45,212,191,.07);color:#2dd4bf;border:1px solid rgba(45,212,191,.18)}

/* RATE+SPARK */
.rate-spark-col{display:flex;flex-direction:column;align-items:center;gap:4px}
.rate-num{font-size:17px;font-weight:800;line-height:1}

/* HERO EXPAND */
.hrow{display:grid;grid-template-columns:1fr auto 46px;gap:8px;align-items:center;padding:5px 10px;background:rgba(5,8,15,.7);border-radius:6px;border:1px solid rgba(148,163,184,.04);margin-bottom:3px}
.today-card{background:rgba(148,163,184,.03);border:1px solid rgba(148,163,184,.08);border-radius:8px;padding:9px 12px;margin-bottom:9px}

/* TEAM CARDS */
.team-card{background:var(--card);border:1px solid var(--bdr);border-radius:11px;padding:12px 14px;backdrop-filter:blur(14px);display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:7px}
.tag{font-size:11px;font-weight:700;padding:2px 9px;background:rgba(148,163,184,.05);border:1px solid rgba(148,163,184,.12);border-radius:20px;color:#94a3b8}
.hero-chip{font-size:10px;padding:1px 6px;border-radius:7px;font-weight:600}
.hero-chip-0{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);color:#fbbf24}
.hero-chip-1{background:rgba(148,163,184,.05);border:1px solid rgba(148,163,184,.1);color:#475569}
.hero-chip-2{background:rgba(148,163,184,.03);border:1px solid rgba(148,163,184,.07);color:#334155}

/* TIMELINE */
.timeline-wrap{position:relative;padding-left:26px}
.timeline-line{position:absolute;left:8px;top:8px;bottom:0;width:2px;background:linear-gradient(to bottom,rgba(148,163,184,.3),rgba(148,163,184,.03))}
.tl-date-node{position:relative;margin-bottom:18px}
.tl-dot{position:absolute;left:-21px;top:3px;width:11px;height:11px;border-radius:50%;background:#475569;border:2px solid rgba(2,4,8,.97);box-shadow:0 0 8px rgba(148,163,184,.2);z-index:1}
.tl-dot.new{background:#4ade80;box-shadow:0 0 12px rgba(74,222,128,.5)}
.tl-date-label{display:flex;align-items:center;gap:8px;margin-bottom:7px;flex-wrap:wrap;cursor:pointer;user-select:none}
.tl-date-text{font-size:14px;font-weight:700;color:#94a3b8}
.new-badge{background:rgba(74,222,128,.1);color:#4ade80;border:1px solid rgba(74,222,128,.25);font-size:10px;font-weight:700;padding:1px 6px;border-radius:7px}
.tl-date-meta{display:flex;gap:8px;font-size:11px;align-items:center;flex-wrap:wrap}
.tl-toggle{font-size:11px;color:#1e293b;margin-left:auto}
.tl-matches{overflow:hidden;transition:max-height .3s ease}
.match-compact{background:rgba(5,8,15,.8);border:1px solid var(--bdr);border-radius:9px;margin-bottom:7px;overflow:hidden}
.match-compact-head{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;border-bottom:1px solid rgba(148,163,184,.04);background:rgba(2,4,8,.6)}
.match-teams{display:grid;grid-template-columns:1fr 1fr}
.match-team-col{padding:9px 12px}
.match-team-col:first-child{border-right:1px solid rgba(148,163,184,.04)}
.match-team-name{font-size:12px;font-weight:800;margin-bottom:5px}
.match-player-line{display:flex;justify-content:space-between;padding:2px 0;font-size:11px}

/* TOOLS */
.pick-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(84px,1fr));gap:8px;margin-bottom:18px}
.pick-item{padding:9px 6px;text-align:center;cursor:pointer;border-radius:8px;background:rgba(5,8,15,.8);border:1px solid rgba(148,163,184,.08);color:#475569;font-weight:600;font-size:13px;transition:all .15s}
.pick-item.sel{background:rgba(148,163,184,.08);border-color:#64748b;color:#cbd5e1;box-shadow:0 0 10px rgba(148,163,184,.06)}
.rand-btn{padding:11px 40px;border-radius:8px;border:none;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s}
.rand-btn.on{background:linear-gradient(135deg,#475569,#64748b);color:#f1f5f9;box-shadow:0 4px 16px rgba(100,116,139,.25)}
.rand-btn.off{background:rgba(10,14,25,.6);color:#1e293b;cursor:not-allowed}
.team-result-card{background:var(--card);backdrop-filter:blur(14px);border:1px solid var(--bdr);border-radius:13px;padding:18px 20px}
.team-result-teams{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.result-team{padding:12px 14px;border-radius:9px;background:rgba(5,8,15,.8)}
.export-btn{padding:8px 22px;border-radius:7px;border:1px solid rgba(148,163,184,.15);background:rgba(5,8,15,.8);color:#64748b;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.export-btn:hover{background:rgba(148,163,184,.08);color:#94a3b8}
footer{text-align:center;padding-top:36px;color:#0c1118;font-size:10px;letter-spacing:2px}
@media(max-width:520px){
  .ptable-wrap{overflow-x:auto}
  .ptable-head,.prow-wrap{min-width:400px}
  .match-teams,.team-result-teams{grid-template-columns:1fr}
  .match-team-col:first-child{border-right:none;border-bottom:1px solid rgba(148,163,184,.04)}
}
</style>
</head>
<body>
<div id="header">
  <div id="header-inner">
    <div class="brand-row">
      <div id="castle-icon">
        <img src="https://raw.githubusercontent.com/ronaldseeyou/NobunagasAmbition/main/images/p4JFAns.jpg" alt="icon" onerror="this.style.display='none'"/>
      </div>
      <div style="flex:1;min-width:0">
        <div class="brand-title">ä¿¡é•·ä¹‹é‡æœ› æˆ°ç¸¾ç¶²</div>
        <div class="brand-sub">å³æ™‚çµ±è¨ˆ Â· é™£ç‡Ÿå°æŠ— Â· è‹±é›„æ•¸æ“š</div>
      </div>
      <div id="live-badge" style="background:rgba(100,116,139,.1);border:1px solid rgba(100,116,139,.3);color:#475569">â³ SYNC</div>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="setTab('players')">ğŸ‘¥ ç©å®¶</button>
      <button class="tab-btn" onclick="setTab('matches')">ğŸ“… æ¯æ—¥å°æˆ°</button>
      <button class="tab-btn" onclick="setTab('tools')">ğŸ› ï¸ å·¥å…·</button>
    </div>
  </div>
</div>
<div id="app">
  <div id="pane-players" class="tab-pane active"></div>
  <div id="pane-matches" class="tab-pane"></div>
  <div id="pane-tools" class="tab-pane"></div>
</div>

<script>
const SHEET_ID='1dTL4GswalL2faUeKUfe0NhNuj39RmodSa7zBNjVTM-U';
const CSV_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

const dateNum=d=>{const m=d.match(/(\d+)æœˆ(\d+)æ—¥/);return m?+m[1]*100+ +m[2]:0;};
const matchNum=s=>{const m=s.match(/ç¬¬(\d+)å ´/);return m?+m[1]:0;};
const rateCol=r=>r>=60?'#4ade80':r>=40?'#fbbf24':'#f87171';

function parseCSV(text){
  const lines=text.trim().split('\n');let hi=0;
  for(let i=0;i<Math.min(lines.length,10);i++){if(lines[i].includes('ç©å®¶')||lines[i].toLowerCase().includes('player')){hi=i;break;}}
  return lines.slice(hi+1).map(line=>{
    const cols=[];let cur='',inQ=false;
    for(const ch of line){if(ch==='"')inQ=!inQ;else if(ch===','&&!inQ){cols.push(cur.trim());cur='';}else cur+=ch;}
    cols.push(cur.trim());
    const c=cols.map(x=>x.replace(/"/g,'').trim());
    const[date,match,betStr,wl,sideRaw,player,hero]=c;
    if(!date||!wl||!player)return null;
    const side=sideRaw==='ç¹”ç”°è»'||sideRaw.toLowerCase()==='oda'?'oda':'united';
    return{date,match,bet:parseInt(betStr)||0,wl:wl.toUpperCase(),side,player,hero:hero||''};
  }).filter(Boolean);
}

function buildMatches(rows){
  const map={};
  rows.forEach(r=>{
    const key=`${r.date}_${r.match}`;
    if(!map[key])map[key]={date:r.date,match:r.match,bet:r.bet,oda:[],united:[],winner:null};
    (r.side==='oda'?map[key].oda:map[key].united).push({player:r.player,hero:r.hero});
    if(r.wl==='W')map[key].winner=r.side;
  });
  return Object.values(map).sort((a,b)=>{const dd=dateNum(b.date)-dateNum(a.date);return dd!==0?dd:matchNum(a.match)-matchNum(b.match);});
}

function buildPlayerStats(matches){
  const pd={};
  const ensure=n=>{if(!pd[n])pd[n]={name:n,wins:0,losses:0,money:0,history:[],heroes:{},byDate:{}};};
  matches.forEach(m=>{
    const oc=m.oda.length,uc=m.united.length,bet=m.bet;
    let odD=0,unD=0;
    if(m.winner==='oda'){odD=oc>0?(uc*bet/oc):0;unD=-bet;}
    else{unD=uc>0?(oc*bet/uc):0;odD=-bet;}
    const proc=(list,isWin,delta)=>{list.forEach(p=>{
      ensure(p.player);const d=pd[p.player];
      isWin?d.wins++:d.losses++;d.money+=delta;
      d.history.push({won:isWin,dn:dateNum(m.date),mn:matchNum(m.match),date:m.date,hero:p.hero,delta});
      if(!d.byDate[m.date])d.byDate[m.date]={wins:0,losses:0,money:0,heroes:[]};
      isWin?d.byDate[m.date].wins++:d.byDate[m.date].losses++;
      d.byDate[m.date].money+=delta;
      d.byDate[m.date].heroes.push(p.hero);
      if(!d.heroes[p.hero])d.heroes[p.hero]={wins:0,losses:0};
      isWin?d.heroes[p.hero].wins++:d.heroes[p.hero].losses++;
    });};
    proc(m.oda,m.winner==='oda',odD);
    proc(m.united,m.winner==='united',unD);
  });
  return Object.values(pd).map(p=>{
    p.history.sort((a,b)=>a.dn!==b.dn?a.dn-b.dn:a.mn-b.mn);
    const total=p.wins+p.losses,rate=total?Math.round(p.wins/total*100):0;
    const heroStats=Object.entries(p.heroes).map(([name,{wins,losses}])=>({name,wins,losses,total:wins+losses})).sort((a,b)=>b.total-a.total||b.wins-a.wins);
    const spark=p.history.slice(-5).map(h=>h.won?1:0);
    while(spark.length<5)spark.unshift(null);
    const lastWon=p.history.length?p.history[p.history.length-1].won:false;
    let streak=0;for(let i=p.history.length-1;i>=0;i--){if(p.history[i].won===lastWon)streak++;else break;}
    const dates=Object.keys(p.byDate).sort((a,b)=>dateNum(b)-dateNum(a));
    const latestDay=dates[0]?{date:dates[0],...p.byDate[dates[0]]}:null;
    return{...p,total,rate,heroStats,spark,streak,streakWin:lastWon,latestDay};
  });
}

function buildTeamStats(matches){
  const tm={};
  matches.forEach(m=>{[['oda',m.oda],['united',m.united]].forEach(([side,pls])=>{
    const won=m.winner===side;
    const key=[...pls].map(p=>p.player).sort().join('Â·');
    if(!tm[key])tm[key]={key,members:[...pls].map(p=>p.player).sort(),wins:0,losses:0,heroes:{}};
    won?tm[key].wins++:tm[key].losses++;
    pls.forEach(p=>{tm[key].heroes[p.hero]=(tm[key].heroes[p.hero]||0)+1;});
  });});
  return Object.values(tm).map(t=>{
    const total=t.wins+t.losses,rate=total?Math.round(t.wins/total*100):0;
    const topHeroes=Object.entries(t.heroes).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([h])=>h);
    return{...t,total,rate,topHeroes};
  }).filter(t=>t.total>=2).sort((a,b)=>b.rate-a.rate||b.total-a.total);
}

function calcBestTeammate(playerName,matches){
  const pw={},pt={};
  matches.forEach(m=>{[['oda',m.oda],['united',m.united]].forEach(([side,pls])=>{
    const won=m.winner===side,names=pls.map(p=>p.player);
    if(!names.includes(playerName))return;
    names.forEach(n=>{if(n===playerName)return;pt[n]=(pt[n]||0)+1;if(won)pw[n]=(pw[n]||0)+1;});
  });});
  let best=null,bestR=-1;
  Object.keys(pt).forEach(n=>{if(pt[n]<2)return;const r=(pw[n]||0)/pt[n];if(r>bestR){bestR=r;best=n;}});
  return best&&bestR>=0.6?best:null;
}

/* sparkline: 5 solid dots only, green=win red=lose, no line */
function sparklineHTML(spark,col,w=72,h=16){
  const n=spark.length,r=5,gap=(w-r*2)/(n-1);
  const dots=spark.map((v,i)=>{
    if(v===null)return`<circle cx="${r+i*gap}" cy="${h/2}" r="${r}" fill="rgba(255,255,255,0.06)"/>`;
    return`<circle cx="${r+i*gap}" cy="${h/2}" r="${r}" fill="${v===1?'#4ade80':'#f87171'}"/>`;
  }).join('');
  return`<svg width="${w}" height="${h}" style="overflow:visible;display:block">${dots}</svg>`;
}

function computeBadges(players,matches){
  const maxM=Math.max(...players.map(p=>p.money));
  const minM=Math.min(...players.map(p=>p.money));
  const maxPool=Math.max(...players.map(p=>p.heroStats.length));

  /* MVP: latest date, highest money; tie-breaker = most total games that day */
  const allDates=[...new Set(players.flatMap(p=>Object.keys(p.byDate)))].sort((a,b)=>dateNum(b)-dateNum(a));
  const latestDate=allDates[0];
  const mvpNames=new Set();
  if(latestDate){
    let mvpM=-Infinity,mvpGames=-1;
    players.forEach(p=>{
      const d=p.byDate[latestDate];if(!d||d.money<=0)return;
      if(d.money>mvpM){mvpM=d.money;mvpGames=d.wins+d.losses;mvpNames.clear();mvpNames.add(p.name);}
      else if(d.money===mvpM){
        const g=d.wins+d.losses;
        if(g>mvpGames){mvpGames=g;mvpNames.clear();mvpNames.add(p.name);}
        else if(g===mvpGames){mvpNames.add(p.name);}
      }
    });
    if(mvpM<=0)mvpNames.clear();
  }

  const btMap={};players.forEach(p=>{btMap[p.name]=calcBestTeammate(p.name,matches);});
  const btCount={};Object.values(btMap).forEach(n=>{if(n)btCount[n]=(btCount[n]||0)+1;});
  const topBT=Object.entries(btCount).sort((a,b)=>b[1]-a[1])[0]?.[0]||null;

  return players.map(p=>{
    const badges=[];
    if(p.streakWin&&p.streak>=3)badges.push({cls:'badge-win',txt:`ğŸ”¥${p.streak}é€£å‹`});
    if(!p.streakWin&&p.streak>=3)badges.push({cls:'badge-lose',txt:`â„ï¸${p.streak}é€£æ•—`});
    if(p.money===maxM&&p.money>0)badges.push({cls:'badge-gold',txt:'ğŸ’°å¤§æˆ¶'});
    if(p.money===minM&&p.money<0)badges.push({cls:'badge-lose',txt:'ğŸ’¸ç ´ç”¢'});
    if(p.heroStats.length===maxPool&&maxPool>3)badges.push({cls:'badge-blue',txt:'ğŸ¯è‹±é›„ç‹'});
    if(mvpNames.has(p.name))badges.push({cls:'badge-purple',txt:'ğŸ“ˆMVP'});
    if(p.name===topBT)badges.push({cls:'badge-teal',txt:'ğŸ¤æœ€ä½³éšŠå“¡'});
    return{...p,badges};
  });
}

let openedPlayer=null,hSort='count';
let allPlayers=[],allMatches=[],allTeams=[],allPNames=[];

function renderPlayers(){
  const withBadges=computeBadges(allPlayers,allMatches);
  /* sort: rate desc, then total games desc */
  const sorted=[...withBadges].sort((a,b)=>b.rate-a.rate||b.total-a.total);
  const odaW=allMatches.filter(m=>m.winner==='oda').length;
  const totM=allMatches.length;
  const odaPct=totM?Math.round(odaW/totM*100):50,uniPct=100-odaPct;
  const odaCol=odaPct>=uniPct?'#4ade80':'#f87171',uniCol=uniPct>odaPct?'#4ade80':'#f87171';

  let html=`
  <div class="sec-bar"><span>âš”ï¸ é™£ç‡Ÿå‹ç‡ Â· å…± ${totM} å ´</span></div>
  <div class="card">
    <div class="fac-nums">
      <div><div class="fac-big" style="color:${odaCol}">${odaPct}%</div><div class="fac-lbl">ğŸ”´ ç¹”ç”°è» Â· ${odaW} å‹</div></div>
      <div style="text-align:right"><div class="fac-big" style="color:${uniCol}">${uniPct}%</div><div class="fac-lbl">è¯åˆè» Â· ${totM-odaW} å‹ ğŸ”µ</div></div>
    </div>
    <div class="fac-track">
      <div class="fac-seg" id="fac-oda" style="width:0;background:${odaPct>=uniPct?'linear-gradient(90deg,#14532d,#4ade80)':'linear-gradient(90deg,#7f1d1d,#f87171)'}"></div>
      <div class="fac-seg" id="fac-uni" style="width:0;background:${uniPct>odaPct?'linear-gradient(90deg,#14532d,#4ade80)':'linear-gradient(90deg,#7f1d1d,#f87171)'}"></div>
    </div>
  </div>
  <div class="sec-bar"><span>ğŸ† ç©å®¶ç¸½è¦½</span></div>
  <div class="ptable-wrap">
    <div class="ptable-head">
      <span>#</span><span>ç©å®¶</span>
      <span style="text-align:center">å‹ç‡ Â· èµ°å‹¢</span>
      <span style="text-align:center">è‹±é›„</span>
      <span style="text-align:right">é‡‘é¡</span>
    </div>`;

  sorted.forEach((p,i)=>{
    const col=rateCol(p.rate);
    const rankIcon=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1;
    const rankCol=i===0?'#fbbf24':i===1?'#94a3b8':i===2?'#78350f':'#334155';
    const isOpen=openedPlayer===p.name;
    const moneyRaw=Math.round(p.money*10)/10;
    const moneyStr=`${moneyRaw>=0?'+':''}$${moneyRaw}`;
    const moneyColor=moneyRaw>=0?'#4ade80':'#f87171';
    const isTopEarner=p.badges.some(b=>b.txt==='ğŸ’°å¤§æˆ¶');
    const rowCls=p.streakWin?'last-win':'last-lose';
    const badgeHTML=p.badges.map(b=>`<span class="badge ${b.cls}">${b.txt}</span>`).join('');

    html+=`<div>
      <div class="prow-wrap ${rowCls}${isOpen?' open':''}" onclick="togglePlayer('${p.name}')">
        <div style="font-size:${i<3?15:12}px;color:${rankCol};font-weight:700;text-align:center">${rankIcon}</div>
        <div>
          <div style="display:flex;align-items:center;flex-wrap:wrap;line-height:1.3">
            <span style="font-size:14px;font-weight:700;color:#e2e8f0">${p.name}</span>
            <span style="margin-left:5px">${badgeHTML}</span>
          </div>
          <div style="font-size:12px;margin-top:3px;display:flex;gap:5px;align-items:baseline">
            <span style="color:#4ade80;font-weight:700">${p.wins}W</span>
            <span style="color:#1e293b">/</span>
            <span style="color:#f87171;font-weight:700">${p.losses}L</span>
            <span style="color:#1e293b;font-size:11px">${p.total}å ´</span>
          </div>
        </div>
        <div class="rate-spark-col">
          <div class="rate-num" style="color:${col}">${p.rate}%</div>
          ${sparklineHTML(p.spark,col,72,16)}
        </div>
        <div style="text-align:center">
          <div style="font-size:16px;font-weight:800;color:#64748b">${p.heroStats.length}</div>
        </div>
        <div style="text-align:right">
          <div style="${isTopEarner?'background:rgba(251,191,36,.06);border-radius:5px;padding:1px 5px;':''}font-weight:700;font-size:14px;color:${moneyColor};display:inline-block">${moneyStr}</div>
        </div>
      </div>
      <div class="hero-expand-row" id="expand-${p.name}" style="max-height:${isOpen?'2000px':'0'};transition:max-height .3s ease">
        ${isOpen?heroExpandHTML(p):''}
      </div>
    </div>`;
  });

  html+=`</div>
  <div style="text-align:center;font-size:10px;color:#0f172a;margin-bottom:22px">â†‘ é»æ“Šè¡Œå±•é–‹è‹±é›„æ± è©³æƒ… â†‘</div>
  <div class="sec-bar"><span>ğŸ¤ çµ„éšŠå‹ç‡</span></div>`;

  allTeams.forEach((t,ti)=>{
    const heroChips=t.topHeroes.map((h,idx)=>`<span class="hero-chip hero-chip-${idx}">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][idx]} ${h}</span>`).join('');
    html+=`<div class="team-card fade-up" style="animation-delay:${ti*.04}s">
      <div style="flex-shrink:0;min-width:46px;text-align:center">
        <div style="font-size:20px;font-weight:800;color:${rateCol(t.rate)}">${t.rate}%</div>
      </div>
      <div style="flex:1;min-width:120px">
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px">${t.members.map(m=>`<span class="tag">${m}</span>`).join('')}</div>
        <div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px">
          <span style="font-size:9px;color:#1e293b;margin-right:2px">é»˜å¥‘è‹±é›„</span>${heroChips}
        </div>
      </div>
      <div style="text-align:right;flex-shrink:0;min-width:52px">
        <div style="display:flex;align-items:baseline;justify-content:flex-end;gap:2px">
          <span style="color:#4ade80;font-weight:700;font-size:15px">${t.wins}</span><span style="color:#1e293b;font-size:10px">W</span>
          <span style="color:#0d1117;margin:0 1px">Â·</span>
          <span style="color:#f87171;font-size:15px;font-weight:600">${t.losses}</span><span style="color:#1e293b;font-size:10px">L</span>
        </div>
        <div style="font-size:10px;color:#334155;margin-top:1px">${t.total} å ´</div>
      </div>
    </div>`;
  });

  document.getElementById('pane-players').innerHTML=html;
  setTimeout(()=>{
    const od=document.getElementById('fac-oda'),un=document.getElementById('fac-uni');
    const p2=totM?Math.round(odaW/totM*100):50;
    if(od)od.style.width=`${p2}%`;if(un)un.style.width=`${100-p2}%`;
  },100);
}

function heroExpandHTML(p){
  const s=[...p.heroStats].sort((a,b)=>{
    if(hSort==='rate'){const ra=a.total?a.wins/a.total:0,rb=b.total?b.wins/b.total:0;return rb-ra||b.total-a.total;}
    return b.total-a.total;
  });
  const sortBtns=['count','rate'].map(k=>`<button onclick="setHSort('${k}',event)" style="padding:2px 8px;background:${hSort===k?'#475569':'rgba(5,8,15,.8)'};color:${hSort===k?'#f1f5f9':'#334155'};border:1px solid ${hSort===k?'#64748b':'rgba(148,163,184,.08)'};border-radius:4px;cursor:pointer;font-size:10px;font-weight:700;font-family:inherit">${k==='count'?'æ¬¡æ•¸':'å‹ç‡'}</button>`).join('');
  return`<div style="padding:10px 14px 12px">
    
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:5px">
      <span style="font-size:10px;color:#1e293b;text-transform:uppercase;letter-spacing:.8px;font-weight:700">è‹±é›„æ±  (${p.heroStats.length})</span>
      <div style="display:flex;gap:3px">${sortBtns}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:3px">
      ${s.map(h=>{const hr=h.total?Math.round(h.wins/h.total*100):0;return`
        <div class="hrow">
          <span style="font-size:12px;font-weight:600;color:#cbd5e1">${h.name}</span>
          <span style="font-size:10px;color:#1e293b">${h.total}å ´ Â· ${h.wins}W${h.losses?` / ${h.losses}L`:''}</span>
          <span style="font-size:13px;font-weight:700;color:${rateCol(hr)};text-align:right">${hr}%</span>
        </div>`}).join('')}
    </div>
  </div>`;
}

const openDates=new Set();
function renderMatches(){
  const dg={};
  allMatches.forEach(m=>(dg[m.date]=dg[m.date]||[]).push(m));
  Object.values(dg).forEach(ms=>ms.sort((a,b)=>matchNum(a.match)-matchNum(b.match)));
  const entries=Object.entries(dg).sort(([a],[b])=>dateNum(b)-dateNum(a));
  const newestDate=entries[0]?.[0];
  if(openDates.size===0&&newestDate)openDates.add(newestDate);
  let html=`<div class="sec-bar"><span>ğŸ“… å°æˆ°æ­·å²</span></div>
  <div class="timeline-wrap"><div class="timeline-line"></div>`;
  entries.forEach(([date,ms],di)=>{
    const dOdaW=ms.filter(m=>m.winner==='oda').length;
    const isNewest=date===newestDate,isOpen=openDates.has(date);
    const matchesHTML=ms.map(m=>`<div class="match-compact">
      <div class="match-compact-head">
        <span style="font-size:12px;font-weight:700;color:#334155">${m.match}</span>
        <span style="font-size:11px;font-weight:700;color:#fbbf24">$${m.bet}</span>
      </div>
      <div class="match-teams">
        ${[{team:m.oda,side:'oda',label:'ç¹”ç”°è»'},{team:m.united,side:'united',label:'è¯åˆè»'}].map(({team,side,label})=>{
          const won=m.winner===side,nc=won?'#4ade80':'#f87171';
          return`<div class="match-team-col" style="opacity:${won?1:.5}">
            <div class="match-team-name" style="color:${nc}">${label}
              <span style="font-size:10px;padding:1px 5px;border-radius:4px;margin-left:4px;background:${won?'rgba(74,222,128,.07)':'rgba(248,113,113,.07)'};color:${nc}">${won?'å‹':'æ•—'}</span>
            </div>
            ${team.map(pl=>`<div class="match-player-line">
              <span style="color:${won?'#cbd5e1':'#374151'};font-weight:600">${pl.player}</span>
              <span style="color:${won?'#1e3a5f':'#1f2937'}">${pl.hero}</span>
            </div>`).join('')}
          </div>`;
        }).join('')}
      </div>
    </div>`).join('');
    html+=`<div class="tl-date-node fade-up" style="animation-delay:${di*.05}s">
      <div class="tl-dot${isNewest?' new':''}"></div>
      <div class="tl-date-label" onclick="toggleDate('${date}')">
        <span class="tl-date-text">${date}</span>
        ${isNewest?'<span class="new-badge">NEW</span>':''}
        <div class="tl-date-meta">
          <span style="color:#334155">${ms.length}å ´</span>
          <span style="color:#fbbf24;font-weight:700">$${ms[0]?.bet}/å ´</span>
          <span style="color:#4ade80;font-weight:600">ç¹”ç”°${dOdaW}W</span>
          <span style="color:#f87171;font-weight:600">è¯åˆ${ms.length-dOdaW}W</span>
        </div>
        <span class="tl-toggle">${isOpen?'â–²':'â–¼'}</span>
      </div>
      <div class="tl-matches" style="max-height:${isOpen?'2000px':'0'}">${isOpen?matchesHTML:''}</div>
    </div>`;
  });
  html+=`</div>`;
  document.getElementById('pane-matches').innerHTML=html;
}
function toggleDate(date){openDates.has(date)?openDates.delete(date):openDates.add(date);renderMatches();}

let pickedSet=new Set(),teamRes=null;

async function exportTeamImage(){
  const el=document.getElementById('export-target');
  if(!el)return;
  try{
    const canvas=await html2canvas(el,{backgroundColor:'#0d1117',scale:2,useCORS:true,logging:false});
    const link=document.createElement('a');
    link.download='åˆ†éšŠçµæœ.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  }catch(e){alert('æˆªåœ–å¤±æ•—ï¼Œè«‹é‡è©¦');}
}

function renderTools(){
  const canRand=pickedSet.size>=6&&pickedSet.size<=7;
  const pickItems=allPNames.map(n=>`<div class="pick-item${pickedSet.has(n)?' sel':''}" onclick="togglePick('${n}')">${pickedSet.has(n)?'âœ“ ':''}${n}</div>`).join('');
  const pRateMap={};allPlayers.forEach(p=>{pRateMap[p.name]=p.rate;});

  let teamHTML='';
  if(teamRes){
    teamHTML=`<div id="export-target" class="team-result-card fade-up" style="margin-top:18px">
      <div style="text-align:center;font-size:17px;font-weight:700;color:#e2e8f0;margin-bottom:14px">âš”ï¸ åˆ†éšŠçµæœ</div>
      <div class="team-result-teams">
        ${[{team:teamRes.oda,label:'ğŸ”´ ç¹”ç”°è»',col:'#ef4444'},{team:teamRes.united,label:'ğŸ”µ è¯åˆè»',col:'#3b82f6'}].map(({team,label,col})=>{
          const avgRate=team.length?Math.round(team.reduce((s,n)=>s+(pRateMap[n]||0),0)/team.length):0;
          return`<div class="result-team" style="border-top:2px solid ${col}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:9px">
              <span style="font-size:12px;font-weight:800;color:${col}">${label}</span>
              <span style="font-size:11px;font-weight:700;color:${rateCol(avgRate)}">å‡ ${avgRate}%</span>
            </div>
            ${team.map((n,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:${i<team.length-1?'1px solid rgba(255,255,255,.04)':'none'}">
              <span style="font-size:14px;font-weight:600;color:#e2e8f0">${n}</span>
              <span style="font-size:12px;font-weight:700;color:${rateCol(pRateMap[n]||0)}">${pRateMap[n]||0}%</span>
            </div>`).join('')}
          </div>`;
        }).join('')}
      </div>
    </div>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:12px">
      <button onclick="doRandom()" style="padding:7px 22px;border-radius:7px;border:1px solid rgba(148,163,184,.1);background:rgba(5,8,15,.8);color:#475569;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">ğŸ² é‡æ–°åˆ†éšŠ</button>
      <button onclick="exportTeamImage()" class="export-btn">ğŸ“¸ å„²å­˜åœ–ç‰‡</button>
    </div>`;
  }

  document.getElementById('pane-tools').innerHTML=`
    <div class="sec-bar"><span>ğŸ² éš¨æ©Ÿåˆ†éšŠå·¥å…·</span></div>
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span style="font-size:14px;font-weight:600;color:#cbd5e1">é¸æ“‡ 6 æˆ– 7 ä½ç©å®¶</span>
        <span style="font-size:12px;color:${canRand?'#4ade80':'#334155'}">å·²é¸ ${pickedSet.size} äºº${canRand?' âœ“':''}</span>
      </div>
      <div class="pick-grid">${pickItems}</div>
      <div style="text-align:center"><button onclick="doRandom()" class="rand-btn ${canRand?'on':'off'}">ğŸ² éš¨æ©Ÿåˆ†éšŠ</button></div>
    </div>${teamHTML}`;
}

function setTab(id){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',['players','matches','tools'][i]===id));
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.getElementById(`pane-${id}`).classList.add('active');
}
function togglePlayer(name){
  openedPlayer=openedPlayer===name?null:name;
  renderPlayers();
  setTimeout(()=>{
    const od=document.getElementById('fac-oda'),un=document.getElementById('fac-uni');
    const w=allMatches.filter(m=>m.winner==='oda').length,t=allMatches.length,pct=t?Math.round(w/t*100):50;
    if(od)od.style.width=`${pct}%`;if(un)un.style.width=`${100-pct}%`;
  },100);
}
function setHSort(k,e){
  e&&e.stopPropagation();hSort=k;
  if(openedPlayer){const el=document.getElementById(`expand-${openedPlayer}`);const p=allPlayers.find(x=>x.name===openedPlayer);if(el&&p)el.innerHTML=heroExpandHTML(p);}
}
function togglePick(n){pickedSet.has(n)?pickedSet.delete(n):pickedSet.add(n);renderTools();}
function doRandom(){
  if(pickedSet.size<6||pickedSet.size>7)return alert('è«‹é¸æ“‡ 6 æˆ– 7 ä½ç©å®¶ï¼');
  const sel=[...pickedSet];
  for(let i=sel.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[sel[i],sel[j]]=[sel[j],sel[i]];}
  const h=Math.ceil(sel.length/2);teamRes={oda:sel.slice(0,h),united:sel.slice(h)};renderTools();
}

(async function init(){
  const badge=document.getElementById('live-badge');
  try{
    const ctrl=new AbortController();setTimeout(()=>ctrl.abort(),9000);
    const res=await fetch(CSV_URL,{signal:ctrl.signal});
    if(!res.ok)throw new Error();
    const text=await res.text();const rows=parseCSV(text);
    if(rows.length<2)throw new Error();
    allMatches=buildMatches(rows);
    allPlayers=buildPlayerStats(allMatches);
    allTeams=buildTeamStats(allMatches);
    allPNames=[...new Set(rows.map(r=>r.player))];
    badge.style.cssText='padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;flex-shrink:0;background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.25);color:#4ade80';
    badge.textContent='â— LIVE';
  }catch(e){
    badge.style.cssText='padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;flex-shrink:0;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.25);color:#f87171';
    badge.textContent='âš  ç„¡æ•¸æ“š';
    document.getElementById('pane-players').innerHTML=`<div style="text-align:center;padding:60px 20px;color:#334155">
      <div style="font-size:32px;margin-bottom:12px">ğŸ“­</div>
      <div style="font-size:15px;font-weight:600;margin-bottom:6px;color:#475569">æœªèƒ½è¼‰å…¥æ•¸æ“š</div>
      <div style="font-size:12px">è«‹ç¢ºèª Google Sheet å·²å…±äº«ï¼Œæˆ–ç¨å¾Œé‡è©¦</div>
    </div>`;
  }
  renderPlayers();renderMatches();renderTools();
})();
</script>
<footer>âœ¦ ä¿¡é•·ä¹‹é‡æœ› æˆ°ç¸¾ç¶² Â· æ•¸æ“šç”± Google Sheets é©…å‹• âœ¦</footer>
</body>
</html>
