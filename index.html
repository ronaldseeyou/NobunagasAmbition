<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>ä¿¡é•·ä¹‹é‡æœ› æˆ°ç¸¾çµ±è¨ˆ v13.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg: #020617; --card: #111827; --header-bg: #030712;
      --border: #1f2937; --accent: #38bdf8; --text: #e5e7eb;
      --muted: #9ca3af; 
      --win: #4ade80; --lose: #f87171; --money: #fbbf24; 
      --oda-default: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      --united-default: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      --oda-text: #ef4444; --united-text: #3b82f6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 50%, #000 100%);
      color: var(--text); min-height: 100vh; padding-bottom: 80px;
    }
    
    /* === Sticky Header & Tabs === */
    .sticky-wrapper {
      position: sticky; top: 0; z-index: 50;
      background: rgba(3,7,18,0.95); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    
    header { padding: 16px; text-align: center; }
    .header-content { display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .header-icon { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; border: 3px solid var(--accent); box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
    .header-text { display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 24px; font-weight: 800; color: var(--accent); margin: 0 0 6px 0; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    h2 { font-size: 14px; color: var(--muted); font-weight: 500; margin: 0; opacity: 0.9; }

    .tabs { display: flex; justify-content: center; gap: 4px; padding: 0 16px 12px; overflow-x: auto; }
    .tab { padding: 10px 24px; background: transparent; color: var(--muted); border: none; cursor: pointer; font-size: 17px; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* === Main Container === */
    .container { max-width: 900px; margin: 0 auto; padding: 24px 16px; }
    
    /* Loading/Error */
    #loading-state, #error-state { text-align: center; padding: 40px; font-size: 16px; display: none; }
    #loading-state { color: var(--accent); }
    #error-state { color: #ef4444; }
    
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .section-title { margin: 24px 0 12px; font-size: 18px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 8px; border-left: 4px solid var(--accent); padding-left: 12px; }
    
    /* Sort Buttons */
    .sort-btn { background: #1f2937; border: 1px solid var(--border); color: var(--muted); padding: 4px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; margin-left: 8px; transition: all 0.2s; }
    .sort-btn:hover { background: #374151; color: #fff; }
    .sort-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; }

    /* Faction Stats */
    .faction-stats { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 24px; }
    .faction-header { font-size: 14px; color: var(--muted); margin-bottom: 12px; text-align: center; }
    .faction-bar-container { display: flex; height: 44px; border-radius: 8px; overflow: hidden; background: #1f2937; }
    .faction-bar { display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 15px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); min-width: 10%; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.6); }
    
    /* Table (v13.2 Centered) */
    .table-card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 24px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 600px; }
    
    /* Header & Cell Alignment */
    th { background: #1f2937; color: var(--muted); font-weight: 600; padding: 12px 16px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; text-align: center; }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: var(--text); text-align: center; }
    
    /* First Column (Player Name) remains Left Aligned */
    th:first-child, td:first-child { text-align: left; }
    
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(56, 189, 248, 0.05); }
    
    .player-name { font-weight: 700; color: #fff; }
    .top-heroes { font-size: 12px; color: var(--muted); max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0 auto; /* Centered block */ }
    
    /* Colors */
    .win-rate.high { color: var(--win); } .win-rate.mid { color: var(--money); } .win-rate.low { color: var(--lose); }
    .money { font-family: monospace; font-weight: 700; }
    .money.plus { color: var(--win); } .money.minus { color: var(--lose); }
    
    /* === Hero Stats (v13.2 Fixed Colors) === */
    .hero-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    
    .hero-stats-card { 
      background: var(--card); border: 1px solid var(--border); border-radius: 12px; 
      overflow: hidden; padding-bottom: 8px; 
    }
    
    .hero-stats-header {
      background: rgba(3, 7, 18, 0.4); font-size: 18px; font-weight: 700; color: #fff;
      padding: 14px 20px; border-bottom: 1px solid var(--border);
    }

    .hero-list {
      margin-top: 8px; padding: 0 16px;
    }

    .hero-row {
      display: grid; grid-template-columns: 1fr auto 60px; /* Name | Stats | Rate */
      align-items: center; padding: 10px 8px; font-size: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      gap: 12px;
    }
    .hero-row:last-child { border-bottom: none; }

    .hero-name {
      font-weight: 500; color: #fff; display: flex; align-items: center; gap: 8px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left;
    }
    .hero-name::before {
      content: 'â€¢'; color: var(--muted); font-size: 14px;
    }

    .hero-stats {
      color: var(--muted); font-size: 13px; text-align: right;
    }

    /* Fixed Specificity for Hero Rate Colors */
    .hero-rate { font-weight: 700; text-align: right; }
    span.hero-rate.high { color: var(--win) !important; }
    span.hero-rate.mid { color: var(--money) !important; }
    span.hero-rate.low { color: var(--lose) !important; }
    
    /* Matches List (v11 Style) */
    .date-group { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .date-header { font-size: 18px; font-weight: 700; color: var(--accent); margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
    
    .match-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 10px; margin-bottom: 12px; padding: 14px; }
    .match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 13px; padding-bottom: 8px; border-bottom: 1px solid #1e293b; }
    .match-number { color: var(--muted); font-weight: 600; }
    .match-bet { color: var(--money); font-weight: 600; }
    
    .match-teams { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .team { padding: 10px; border-radius: 8px; }
    .team.oda { border: 1px solid rgba(239, 68, 68, 0.3); }
    .team.united { border: 1px solid rgba(59, 130, 246, 0.3); }
    
    .team.oda.winner, .team.united.winner { background: rgba(74, 222, 128, 0.15); border-color: rgba(74, 222, 128, 0.4); }
    .team.oda.loser, .team.united.loser { background: rgba(248, 113, 113, 0.15); border-color: rgba(248, 113, 113, 0.4); }
    
    .team-header { font-size: 13px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .team.oda .team-header { color: var(--oda-text); }
    .team.united .team-header { color: var(--united-text); }
    .team.winner .team-header::before { content: "âœ…"; }
    .team.loser .team-header::before { content: "âŒ"; opacity: 0.5; }
    
    .match-player { font-size: 13px; margin-bottom: 6px; line-height: 1.5; padding: 4px 0; }
    .match-player strong { color: var(--text); font-weight: 600; }
    .match-player span { opacity: 0.7; font-size: 12px; margin-left: 6px; }


    /* Tools */
    .tools-card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 24px; text-align: center; }
    .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin: 20px 0; text-align: left; }
    .player-checkbox { display: flex; align-items: center; gap: 10px; padding: 12px; background: #0f172a; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .player-checkbox.selected { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); }
    .player-checkbox label { cursor: pointer; font-weight: 500; font-size: 14px; }
    
    .btn { padding: 12px 32px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.1s; background: linear-gradient(135deg, var(--accent) 0%, #0ea5e9 100%); color: #fff; }
    .btn:active { transform: scale(0.98); }
    .btn-secondary { background: #374151; }

    #team-result-container { margin-top: 32px; display: none; }
    .team-display { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
    .teams-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px; }
    .team-box { padding: 16px; border-radius: 8px; background: rgba(0,0,0,0.2); border-top: 4px solid #555; }
    .team-box.oda { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
    .team-box.united { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
    .team-box-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; text-transform: uppercase; }
    .team-box.oda .team-box-title { color: #ef4444; } .team-box.united .team-box-title { color: #3b82f6; }
    .team-box-player { font-size: 15px; font-weight: 600; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

    @media (max-width: 768px) {
      .header-content { flex-direction: row; text-align: left; }
      .header-icon { width: 60px; height: 60px; }
      .header-text { align-items: flex-start; }
      h1 { font-size: 20px; }
      .match-teams, .teams-grid { grid-template-columns: 1fr; }
      .team { margin-bottom: 8px; }
    }
  </style>
</head>
<body>

<div class="sticky-wrapper">
  <header>
    <div class="container" style="padding:0; margin:0 auto;">
      <div class="header-content">
        <img src="images/p4JFAns.jpg" alt="Logo" class="header-icon" onerror="this.style.display='none'">
        <div class="header-text">
          <h1>âš”ï¸ ä¿¡é•·ä¹‹é‡æœ› æˆ°ç¸¾ç¶²</h1>
          <h2>å³æ™‚çµ±è¨ˆ / é™£ç‡Ÿå°æŠ— / è‹±é›„æ•¸æ“š</h2>
        </div>
      </div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('players')">ğŸ‘¥ ç©å®¶</button>
    <button class="tab" onclick="switchTab('matches')">ğŸ“… æ¯æ—¥å°æˆ°</button>
    <button class="tab" onclick="switchTab('tools')">ğŸ› ï¸ å·¥å…·</button>
  </div>
</div>

<div class="container">
  <div id="loading-state">â³ æ­£åœ¨å¾ Google Sheets è¼‰å…¥æ•¸æ“š...</div>
  <div id="error-state"></div>

  <div id="main-content" style="display: none;">
    
    <!-- Players Tab -->
    <div id="players-tab" class="tab-content active">
      <div class="section-title">âš”ï¸ é™£ç‡Ÿå‹ç‡</div>
      <div class="faction-stats">
        <div class="faction-header">ç¸½å…± <span id="total-matches">0</span> å ´å°æˆ°</div>
        <div class="faction-bar-container">
          <div class="faction-bar" id="oda-bar"><span id="oda-text">ç¹”ç”°è» 0%</span></div>
          <div class="faction-bar" id="united-bar"><span id="united-text">è¯åˆè» 0%</span></div>
        </div>
      </div>

      <div class="section-title">ğŸ† ç©å®¶ç¸½è¦½</div>
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>ç©å®¶</th><th>å ´æ•¸ (W/L)</th><th>å‹ç‡</th><th>è‹±é›„æ± </th><th>Top 3 å¸¸ç”¨è‹±é›„</th><th>ç¸½é‡‘é¡</th>
            </tr>
          </thead>
          <tbody id="player-overview-body"></tbody>
        </table>
      </div>

      <div class="section-title">
        ğŸ¯ ç©å®¶è‹±é›„å‹ç‡
        <button class="sort-btn active" id="sort-count-btn" onclick="setHeroSort('count')">æŒ‰æ¬¡æ•¸</button>
        <button class="sort-btn" id="sort-rate-btn" onclick="setHeroSort('rate')">æŒ‰å‹ç‡</button>
      </div>
      <div class="hero-stats-grid" id="hero-stats-container"></div>
    </div>

    <!-- Matches Tab -->
    <div id="matches-tab" class="tab-content">
      <div class="section-title">ğŸ“… å°æˆ°æ­·å²</div>
      <div id="matches-list"></div>
    </div>

    <!-- Tools Tab -->
    <div id="tools-tab" class="tab-content">
      <div class="section-title">ğŸ² éš¨æ©Ÿåˆ†éšŠå·¥å…· (æ”¯æ´ 4vs3)</div>
      <div class="tools-card">
        <div class="tools-title">è«‹é¸æ“‡ 6 æˆ– 7 ä½ç©å®¶</div>
        <div class="player-grid" id="player-selection"></div>
        <button class="btn" onclick="randomTeams()">ğŸ² éš¨æ©Ÿåˆ†éšŠ</button>
      </div>
      
      <div id="team-result-container">
        <div class="team-display" id="capture-area"></div>
        <div style="display:flex; justify-content:center; gap:12px; margin-top:16px;">
          <button class="btn btn-secondary" onclick="randomTeams()">ğŸ² é‡æ–°åˆ†éšŠ</button>
          <button class="btn" onclick="captureImage()">ğŸ“¸ å„²å­˜åœ–ç‰‡åˆ†äº«</button>
        </div>
      </div>
    </div>

    <footer>Last Updated: <span id="last-update"></span></footer>
  </div>
</div>

<script>
  // CONFIG
  const SHEET_ID = '1dTL4GswalL2faUeKUfe0NhNuj39RmodSa7zBNjVTM-U';
  const SHEET_NAME = 'Sheet1';
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

  let matches = [];
  let allPlayers = new Set();
  let calculatedStats = [];
  let calculatedHeroStats = {};
  let currentHeroSort = 'count'; // 'count' or 'rate'

  async function loadData() {
    const loadingEl = document.getElementById('loading-state');
    const mainEl = document.getElementById('main-content');
    const errorEl = document.getElementById('error-state');
    
    loadingEl.style.display = 'block';

    try {
      const response = await fetch(CSV_URL);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const csvText = await response.text();
      matches = parseCSV(csvText);
      
      if (matches.length === 0) throw new Error('æˆåŠŸè®€å–æª”æ¡ˆï¼Œä½†æ‰¾ä¸åˆ°æ•¸æ“šã€‚');

      loadingEl.style.display = 'none';
      mainEl.style.display = 'block';
      renderSite();
      initPlayerSelection();
    } catch (error) {
      console.error(error);
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
      errorEl.innerHTML = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}<br><br>è«‹ç¢ºä¿ Google Sheet æ¨™é¡Œåˆ—åŒ…å«: Date/æ—¥æœŸ, WL/è´è¼¸, Player/ç©å®¶`;
    }
  }

  function parseCSV(csvText) {
    const rows = [];
    let currentRow = [];
    let currentCell = '';
    let insideQuote = false;
    
    // 1. Basic Parsing
    for (let i = 0; i < csvText.length; i++) {
      const char = csvText[i];
      const nextChar = csvText[i+1];
      if (char === '"') {
        if (insideQuote && nextChar === '"') { currentCell += '"'; i++; }
        else { insideQuote = !insideQuote; }
      } else if (char === ',' && !insideQuote) {
        currentRow.push(currentCell.trim()); currentCell = '';
      } else if ((char === '\r' || char === '\n') && !insideQuote) {
        if (char === '\r' && nextChar === '\n') i++;
        if (currentCell || currentRow.length > 0) currentRow.push(currentCell.trim());
        if (currentRow.length > 0) rows.push(currentRow);
        currentRow = []; currentCell = '';
      } else { currentCell += char; }
    }
    if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
    if (rows.length < 2) return [];

    // 2. Intelligent Header Detection
    let headerRowIndex = -1;
    let header = [];
    
    for (let i = 0; i < Math.min(rows.length, 10); i++) {
        const rowLower = rows[i].map(c => c.toLowerCase());
        const hasDate = rowLower.some(c => c.includes('date') || c.includes('æ—¥æœŸ'));
        const hasPlayer = rowLower.some(c => c.includes('player') || c.includes('ç©å®¶'));
        
        if (hasDate && hasPlayer) {
            headerRowIndex = i;
            header = rowLower;
            break;
        }
    }

    if (headerRowIndex === -1) {
        console.warn("Could not detect header row automatically. Using first row.");
        headerRowIndex = 0;
        header = rows[0].map(c => c.toLowerCase());
    }

    const getIdx = (k) => header.findIndex(h => k.some(x => h.includes(x)));

    // Adjusted columns based on user request ("è´è¼¸")
    const idxDate = getIdx(['date', 'æ—¥æœŸ']);
    const idxMatch = getIdx(['match', 'å ´æ¬¡']);
    const idxBet = getIdx(['bet', 'è³­æ³¨']);
    const idxWL = getIdx(['wl', 'w/l', 'winner', 'è´å®¶', 'å‹è² ', 'è´è¼¸', 'result', 'çµæœ']); // Added 'è´è¼¸'
    const idxSide = getIdx(['side', 'é™£ç‡Ÿ', 'team', 'éšŠä¼', 'group']);
    const idxPlayer = getIdx(['player', 'ç©å®¶', 'name', 'å§“å']);
    const idxHero = getIdx(['hero', 'è‹±é›„']);

    if (idxDate === -1 || idxWL === -1 || idxPlayer === -1) {
        console.error("Detected Header:", header);
        throw new Error(`æ‰¾ä¸åˆ°é—œéµæ¬„ä½ (Date, è´è¼¸/WL, Player)ã€‚<br>åµæ¸¬åˆ°çš„æ¨™é¡Œåˆ—: [${rows[headerRowIndex].join(', ')}]`);
    }

    const matchesMap = {};
    const dataRows = rows.slice(headerRowIndex + 1);

    dataRows.forEach(row => {
      if (row.length < 3) return;
      const date = idxDate > -1 ? row[idxDate] : '';
      const matchName = idxMatch > -1 ? row[idxMatch] : '';
      const bet = idxBet > -1 ? (parseInt(row[idxBet]) || 0) : 0;
      const wl = idxWL > -1 ? row[idxWL].toUpperCase() : ''; 
      const side = idxSide > -1 ? row[idxSide] : '';
      const player = idxPlayer > -1 ? row[idxPlayer] : 'Unknown';
      const hero = idxHero > -1 ? row[idxHero] : '';
      
      if (!date || !player) return;
      
      const key = `${date}-${matchName}`;
      if (!matchesMap[key]) {
        matchesMap[key] = {
          date: `${date} ${matchName}`.trim(),
          bet: bet,
          winner: '', 
          oda: [],
          united: []
        };
      }
      
      const isOdaSide = side.includes('ç¹”ç”°') || side.includes('oda');
      
      if (!matchesMap[key].winner) {
          if (isOdaSide && (wl === 'W' || wl === 'WIN' || wl === 'è´')) matchesMap[key].winner = 'oda';
          else if (isOdaSide && (wl === 'L' || wl === 'LOSE' || wl === 'è¼¸')) matchesMap[key].winner = 'united';
          else if (!isOdaSide && (wl === 'W' || wl === 'WIN' || wl === 'è´')) matchesMap[key].winner = 'united';
          else if (!isOdaSide && (wl === 'L' || wl === 'LOSE' || wl === 'è¼¸')) matchesMap[key].winner = 'oda';
      }

      if (isOdaSide) matchesMap[key].oda.push({ name: player, hero });
      else matchesMap[key].united.push({ name: player, hero });
      
      allPlayers.add(player);
    });
    return Object.values(matchesMap);
  }

  function renderSite() {
    const stats = {};
    const heroStats = {};
    let odaWins = 0, unitedWins = 0;

    matches.forEach(m => {
      const odaCount = m.oda.length;
      const unitedCount = m.united.length;
      const bet = m.bet;
      
      let odaDelta = 0;
      let unitedDelta = 0;

      if (m.winner === 'oda') {
        const totalPot = unitedCount * bet;
        odaDelta = odaCount > 0 ? (totalPot / odaCount) : 0; // Use float for now
        unitedDelta = -bet;
        odaWins++;
      } else {
        const totalPot = odaCount * bet;
        unitedDelta = unitedCount > 0 ? (totalPot / unitedCount) : 0; // Use float for now
        odaDelta = -bet;
        unitedWins++;
      }

      m.oda.forEach(p => updatePlayerStats(p, odaDelta, m.winner === 'oda'));
      m.united.forEach(p => updatePlayerStats(p, unitedDelta, m.winner === 'united'));
    });

    function updatePlayerStats(p, moneyDelta, isWin) {
      if (!stats[p.name]) stats[p.name] = { wins: 0, losses: 0, money: 0, heroes: [] };
      if (isWin) stats[p.name].wins++; else stats[p.name].losses++;
      stats[p.name].money += moneyDelta;
      stats[p.name].heroes.push(p.hero);

      if (!heroStats[p.name]) heroStats[p.name] = {};
      if (!heroStats[p.name][p.hero]) heroStats[p.name][p.hero] = { wins: 0, losses: 0 };
      if (isWin) heroStats[p.name][p.hero].wins++; else heroStats[p.name][p.hero].losses++;
    }

    calculatedStats = Object.keys(stats).map(name => {
      const s = stats[name];
      const t = s.wins + s.losses;
      const heroCounts = {};
      s.heroes.forEach(h => heroCounts[h] = (heroCounts[h] || 0) + 1);
      const topHeroes = Object.entries(heroCounts)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 3)
        .map(x => `${x[0]} (${x[1]})`) // New format: Hero (Count)
        .join(', ');

      const uniqueHeroes = new Set(s.heroes).size;

      return { 
        name, ...s, 
        total: t, 
        rate: t ? Math.round((s.wins/t)*100) : 0, 
        topHeroes,
        heroPool: uniqueHeroes
      };
    }).sort((a,b) => b.rate - a.rate || b.total - a.total || b.heroPool - a.heroPool); // Updated Sorting

    calculatedHeroStats = heroStats;

    const total = matches.length;
    const odaPct = total ? Math.round((odaWins/total)*100) : 0;
    const unitedPct = total ? Math.round((unitedWins/total)*100) : 0;
    
    document.getElementById('total-matches').innerText = total;
    const odaBar = document.getElementById('oda-bar');
    const unitedBar = document.getElementById('united-bar');
    odaBar.style.width = `${odaPct}%`; unitedBar.style.width = `${unitedPct}%`;
    document.getElementById('oda-text').innerText = `ç¹”ç”°è» ${odaPct}%`;
    document.getElementById('united-text').innerText = `è¯åˆè» ${unitedPct}%`;
    
    if (odaPct > unitedPct) {
      odaBar.style.background = 'var(--win)'; unitedBar.style.background = 'var(--lose)';
    } else if (unitedPct > odaPct) {
      odaBar.style.background = 'var(--lose)'; unitedBar.style.background = 'var(--win)';
    } else {
      odaBar.style.background = 'var(--oda-default)'; unitedBar.style.background = 'var(--united-default)';
    }

    document.getElementById('player-overview-body').innerHTML = calculatedStats.map(p => `
      <tr>
        <td><span class="player-name">${p.name}</span></td>
        <td>${p.total} <span style="opacity:0.5;font-size:11px">(${p.wins}W/${p.losses}L)</span></td>
        <td class="win-rate ${p.rate>=60?'high':p.rate>=40?'mid':'low'}">${p.rate}%</td>
        <td>${p.heroPool}</td>
        <td><div class="top-heroes">${p.topHeroes}</div></td>
        <td class="money ${p.money>=0?'plus':'minus'}">${p.money>=0?'+':''}$${p.money.toFixed(1)}</td>
      </tr>
    `).join('');

    renderHeroGrid();

    const matchesByDate = {};
    matches.forEach(m => {
      const date = m.date.split(' ')[0];
      if (!matchesByDate[date]) matchesByDate[date] = [];
      matchesByDate[date].push(m);
    });

    document.getElementById('matches-list').innerHTML = Object.entries(matchesByDate).map(([date, ms]) => `
      <div class="date-group"><div class="date-header">${date}</div>
        ${ms.map(m => {
          const mNum = m.date.split(' ')[1] || '';
          const odaCls = m.winner==='oda'?'winner':'loser';
          const uniCls = m.winner==='united'?'winner':'loser';
          const pList = (list) => list.map(p=>`
            <div class="match-player"><strong>${p.name}</strong><span>${p.hero}</span></div>
          `).join('');
          return `
            <div class="match-card">
              <div class="match-header"><span class="match-number">${mNum}</span><span class="match-bet">è³­æ³¨ $${m.bet}</span></div>
              <div class="match-teams">
                <div class="team oda ${odaCls}"><div class="team-header">ç¹”ç”°è»</div>${pList(m.oda)}</div>
                <div class="team united ${uniCls}"><div class="team-header">è¯åˆè»</div>${pList(m.united)}</div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `).join('');
    
    document.getElementById('last-update').innerText = new Date().toLocaleString('zh-HK');
  }

  function setHeroSort(mode) {
    currentHeroSort = mode;
    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`sort-${mode}-btn`).classList.add('active');
    renderHeroGrid();
  }

  function renderHeroGrid() {
    document.getElementById('hero-stats-container').innerHTML = calculatedStats.map(p => {
      const heroes = calculatedHeroStats[p.name] || {};
      const list = Object.entries(heroes).map(([h, s]) => {
        const t = s.wins + s.losses;
        return { name: h, ...s, total: t, rate: t ? Math.round((s.wins/t)*100) : 0 };
      });

      list.sort((a,b) => {
        if (currentHeroSort === 'count') {
          return b.total - a.total || b.rate - a.rate;
        } else {
          return b.rate - a.rate || b.total - a.total;
        }
      });

      return `
        <div class="hero-stats-card">
          <div class="hero-stats-header">${p.name}</div>
          <div class="hero-list">
            ${list.map(h => `
              <div class="hero-row">
                <span class="hero-name">${h.name}</span>
                <span class="hero-stats">${h.total} (${h.wins}W/${h.losses}L)</span>
                <span class="hero-rate ${h.rate>=60?'high':h.rate>=40?'mid':'low'}">${h.rate}%</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }).join('');
  }

  // --- UI & TOOLS ---
  function switchTab(id) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    const idx = id==='players'?0:id==='matches'?1:2;
    document.querySelectorAll('.tab')[idx].classList.add('active');
    document.getElementById(id+'-tab').classList.add('active');
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function initPlayerSelection() {
    const list = Array.from(allPlayers).sort();
    document.getElementById('player-selection').innerHTML = list.map(p => `
      <div class="player-checkbox" onclick="togglePlayer(this)">
        <input type="checkbox" value="${p}"><label>${p}</label>
      </div>
    `).join('');
  }

  function togglePlayer(el) {
    const cb = el.querySelector('input');
    if (event.target !== cb) cb.checked = !cb.checked;
    el.classList.toggle('selected', cb.checked);
  }

  function randomTeams() {
    const sel = Array.from(document.querySelectorAll('#player-selection input:checked')).map(c=>c.value);
    
    if (sel.length !== 6 && sel.length !== 7) {
      return alert('âš ï¸ è«‹é¸æ“‡ 6 æˆ– 7 ä½ç©å®¶ï¼');
    }
    
    for (let i = sel.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [sel[i], sel[j]] = [sel[j], sel[i]];
    }
    
    let splitIndex = Math.ceil(sel.length / 2); // 6->3, 7->4
    if (sel.length === 7 && Math.random() > 0.5) splitIndex = 3; 

    const oda = sel.slice(0, splitIndex);
    const uni = sel.slice(splitIndex);
    
    const now = new Date();
    document.getElementById('team-result-container').style.display = 'block';
    document.getElementById('capture-area').innerHTML = `
      <div class="team-display-header">âš”ï¸ å°æˆ°åˆ†çµ„çµæœ âš”ï¸</div>
      <div class="team-display-date">ğŸ“… ${now.toLocaleDateString()} ${now.toLocaleTimeString('zh-HK',{hour:'2-digit',minute:'2-digit'})}</div>
      <div class="teams-grid">
        <div class="team-box oda"><div class="team-box-title">ğŸ”´ ç¹”ç”°è» (${oda.length}äºº)</div>${oda.map(p=>`<div class="team-box-player">${p}</div>`).join('')}</div>
        <div class="team-box united"><div class="team-box-title">ğŸ”µ è¯åˆè» (${uni.length}äºº)</div>${uni.map(p=>`<div class="team-box-player">${p}</div>`).join('')}</div>
      </div>
    `;
    setTimeout(() => document.getElementById('capture-area').scrollIntoView({behavior:'smooth'}), 100);
  }

  function captureImage() {
    const btn = event.target;
    const original = btn.innerText;
    btn.innerText = "â³..."; btn.disabled = true;
    html2canvas(document.getElementById('capture-area'), { backgroundColor: '#111827', scale: 3 }).then(canvas => {
      const a = document.createElement('a');
      a.download = `ä¿¡é•·åˆ†éšŠ_${Date.now()}.png`;
      a.href = canvas.toDataURL();
      a.click();
      btn.innerText = original; btn.disabled = false;
    });
  }

  loadData();
</script>
</body>
</html>
