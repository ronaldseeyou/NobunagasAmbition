<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>ä¿¡é•·ä¹‹é‡æœ› æˆ°ç¸¾çµ±è¨ˆ v12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- å¼•å…¥æˆªåœ–åŠŸèƒ½æ‰€éœ€çš„ library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg: #020617; --card: #111827; --header-bg: #030712;
      --border: #1f2937; --accent: #38bdf8; --text: #e5e7eb;
      --muted: #9ca3af; --win: #4ade80; --lose: #f87171;
      --money: #fbbf24; --oda: #ef4444; --united: #3b82f6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 50%, #000 100%);
      color: var(--text); min-height: 100vh; padding-bottom: 80px;
    }
    
    /* Header */
    header { position: sticky; top: 0; z-index: 10; padding: 16px; border-bottom: 1px solid var(--border); background: rgba(3,7,18,0.95); backdrop-filter: blur(10px); }
    .header-content { display: flex; align-items: center; gap: 12px; }
    .header-icon { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; border: 2px solid var(--accent); }
    .header-text { flex: 1; }
    h1 { font-size: 20px; font-weight: 700; color: var(--accent); margin-bottom: 4px; }
    h2 { font-size: 13px; color: var(--muted); font-weight: 400; }

    .container { max-width: 900px; margin: 0 auto; padding: 16px; }
    
    /* Loading State */
    #loading-state { text-align: center; padding: 40px; color: var(--accent); font-size: 16px; display: none; }
    #error-state { text-align: center; padding: 40px; color: var(--lose); font-size: 16px; display: none; }

    /* Tabs Style */
    .tabs { display: flex; gap: 8px; margin: 16px 0; border-bottom: 2px solid var(--border); overflow-x: auto; }
    .tab { padding: 12px 20px; background: transparent; color: var(--muted); border: none; cursor: pointer; font-size: 15px; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .section-title { margin: 24px 0 12px; font-size: 16px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px; }
    
    /* Stats & Bars */
    .faction-stats { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 24px; }
    .faction-header { font-size: 14px; color: var(--muted); margin-bottom: 12px; text-align: center; }
    .faction-bar-container { display: flex; height: 50px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .faction-bar { display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; transition: all 0.3s; position: relative; }
    .faction-bar.oda { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
    .faction-bar.united { background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); }
    .faction-bar span { z-index: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    
    /* Table */
    .table-card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
    th { background: #1f2937; color: var(--muted); font-weight: 500; padding: 10px 14px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 12px 14px; border-bottom: 1px solid var(--border); }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(56, 189, 248, 0.05); }
    
    .player-name { font-weight: 600; color: #fff; display: block; }
    .win-rate { font-weight: 700; }
    .win-rate.high { color: var(--win); }
    .win-rate.mid { color: var(--money); }
    .win-rate.low { color: var(--lose); }
    .money { font-family: monospace; font-weight: 600; }
    .money.plus { color: var(--win); }
    .money.minus { color: var(--lose); }

    /* Hero Stats */
    .hero-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .hero-stats-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .hero-stats-header { font-size: 15px; font-weight: 600; color: #fff; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .hero-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 13px; }
    .hero-item:not(:last-child) { border-bottom: 1px solid #1e293b; }
    .hero-name { color: var(--text); font-weight: 500; }
    .hero-stats { color: var(--muted); font-size: 12px; }
    .hero-rate { margin-left: 12px; font-weight: 600; }
    .hero-rate.high { color: var(--win); }
    .hero-rate.mid { color: var(--money); }
    .hero-rate.low { color: var(--lose); }

    /* Matches List */
    .date-group { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .date-header { font-size: 18px; font-weight: 700; color: var(--accent); margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
    .match-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 10px; margin-bottom: 12px; padding: 14px; }
    .match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 13px; padding-bottom: 8px; border-bottom: 1px solid #1e293b; }
    .match-number { color: var(--muted); font-weight: 600; }
    .match-bet { color: var(--money); font-weight: 600; }
    
    .match-teams { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .team { padding: 10px; border-radius: 8px; }
    .team.oda { border: 1px solid rgba(239, 68, 68, 0.3); }
    .team.united { border: 1px solid rgba(59, 130, 246, 0.3); }
    .team.oda.winner, .team.united.winner { background: rgba(74, 222, 128, 0.15); border-color: rgba(74, 222, 128, 0.4); }
    .team.oda.loser, .team.united.loser { background: rgba(248, 113, 113, 0.15); border-color: rgba(248, 113, 113, 0.4); }
    
    .team-header { font-size: 13px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .team.oda .team-header { color: var(--oda); }
    .team.united .team-header { color: var(--united); }
    .team.winner .team-header::before { content: "âœ…"; }
    .team.loser .team-header::before { content: "âŒ"; opacity: 0.5; }
    
    .match-player { font-size: 13px; margin-bottom: 6px; line-height: 1.5; padding: 4px 0; }
    .match-player strong { color: var(--text); font-weight: 600; }
    .match-player span { opacity: 0.7; font-size: 12px; margin-left: 6px; }

    /* Tools Tab Styles */
    .tools-card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 24px; margin-bottom: 20px; }
    .tools-title { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border); }
    
    .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .player-checkbox { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: #0f172a; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .player-checkbox:hover { border-color: var(--accent); }
    .player-checkbox.selected { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); }
    .player-checkbox input[type="checkbox"] { cursor: pointer; }
    .player-checkbox label { cursor: pointer; font-size: 14px; font-weight: 500; }
    
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .btn:active { transform: translateY(0); }
    .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, #0ea5e9 100%); color: #fff; }
    .btn-secondary { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: #fff; }
    
    #team-result-container { margin-top: 24px; display: none; }
    .team-display { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
    .team-display-header { text-align: center; font-size: 20px; font-weight: 700; color: var(--accent); margin-bottom: 8px; }
    .team-display-date { text-align: center; font-size: 13px; color: var(--muted); margin-bottom: 20px; }
    .teams-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .team-box { padding: 20px; border-radius: 10px; }
    .team-box.oda { background: rgba(239, 68, 68, 0.1); border: 2px solid var(--oda); }
    .team-box.united { background: rgba(59, 130, 246, 0.1); border: 2px solid var(--united); }
    .team-box-title { font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; }
    .team-box.oda .team-box-title { color: var(--oda); }
    .team-box.united .team-box-title { color: var(--united); }
    .team-box-player { padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-bottom: 8px; text-align: center; font-size: 16px; font-weight: 600; color: #fff; }
    
    .action-buttons { display: flex; justify-content: center; gap: 12px; margin-top: 20px; }

    footer { text-align: center; font-size: 12px; color: var(--muted); margin-top: 40px; opacity: 0.5; }

    @media (max-width: 768px) {
      .teams-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <div class="container">
    <div class="header-content">
      <img src="images/p4JFAns.jpg" alt="Logo" class="header-icon" onerror="this.src='https://via.placeholder.com/40'">
      <div class="header-text">
        <h1>âš”ï¸ ä¿¡é•·ä¹‹é‡æœ› æˆ°ç¸¾ç¶²</h1>
        <h2>å³æ™‚çµ±è¨ˆ / é™£ç‡Ÿå°æŠ— / è‹±é›„æ•¸æ“š</h2>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <!-- Loading State -->
  <div id="loading-state">â³ æ­£åœ¨å¾ Google Sheets è¼‰å…¥æ•¸æ“š...</div>
  <div id="error-state">âŒ ç„¡æ³•è¼‰å…¥æ•¸æ“šï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– Google Sheet è¨­å®šã€‚</div>

  <!-- Content (Hidden until loaded) -->
  <div id="main-content" style="display: none;">
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('players')">ğŸ‘¥ ç©å®¶</button>
      <button class="tab" onclick="switchTab('matches')">ğŸ“… æ¯æ—¥å°æˆ°</button>
      <button class="tab" onclick="switchTab('tools')">ğŸ› ï¸ å·¥å…·</button>
    </div>

    <!-- Players Tab -->
    <div id="players-tab" class="tab-content active">
      <div class="section-title">âš”ï¸ é™£ç‡Ÿå‹ç‡</div>
      <div class="faction-stats">
        <div class="faction-header">ç¸½å…± <span id="total-matches">0</span> å ´å°æˆ°</div>
        <div class="faction-bar-container">
          <div class="faction-bar oda" id="oda-bar">
            <span id="oda-text">ç¹”ç”°è» 0%</span>
          </div>
          <div class="faction-bar united" id="united-bar">
            <span id="united-text">è¯åˆè» 0%</span>
          </div>
        </div>
      </div>

      <div class="section-title">ğŸ† ç©å®¶ç¸½è¦½</div>
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>ç©å®¶</th>
              <th>å ´æ•¸ (W/L)</th>
              <th>å‹ç‡</th>
              <th>è‹±é›„æ± </th>
              <th>ç¸½é‡‘é¡</th>
            </tr>
          </thead>
          <tbody id="player-overview-body"></tbody>
        </table>
      </div>

      <div class="section-title">ğŸ¯ ç©å®¶è‹±é›„å‹ç‡</div>
      <div class="hero-stats-grid" id="hero-stats-container"></div>
    </div>

    <!-- Matches Tab -->
    <div id="matches-tab" class="tab-content">
      <div class="section-title">ğŸ“… å°æˆ°æ­·å²</div>
      <div id="matches-list"></div>
    </div>

    <!-- Tools Tab -->
    <div id="tools-tab" class="tab-content">
      <div class="section-title">ğŸ² éš¨æ©Ÿåˆ†éšŠå·¥å…·</div>
      <div class="tools-card">
        <div class="tools-title">åƒåŠ ç©å®¶ (è«‹é¸æ“‡ 6 ä½)</div>
        <div class="player-grid" id="player-selection"></div>
        <div style="text-align: center;">
          <button class="btn btn-primary" onclick="randomTeams()">ğŸ² éš¨æ©Ÿåˆ†éšŠ</button>
        </div>
      </div>
      
      <div id="team-result-container">
        <div class="team-display" id="capture-area">
          <!-- Result will be injected here -->
        </div>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="randomTeams()">ğŸ² é‡æ–°åˆ†éšŠ</button>
          <button class="btn btn-secondary" onclick="captureImage()">ğŸ“¸ å„²å­˜åœ–ç‰‡åˆ†äº«</button>
        </div>
      </div>
    </div>

    <footer>
      Last Updated: <span id="last-update"></span>
    </footer>
  </div>
</div>

<script>
  // ==========================================
  // CONFIGURATION
  // ==========================================
  const SHEET_ID = '1dTL4GswalL2faUeKUfe0NhNuj39RmodSa7zBNjVTM-U';
  const SHEET_NAME = 'Sheet1'; // Default sheet name
  
  // URL to fetch data as CSV
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

  let matches = []; // Will be populated from Google Sheets
  let allPlayers = new Set(); // To store unique player names for the tool

  // ==========================================
  // 1. DATA FETCHING & PARSING
  // ==========================================
  
  async function loadData() {
    const loadingEl = document.getElementById('loading-state');
    const mainContentEl = document.getElementById('main-content');
    const errorEl = document.getElementById('error-state');

    loadingEl.style.display = 'block';

    try {
      const response = await fetch(CSV_URL);
      if (!response.ok) throw new Error('Network response was not ok');
      const csvText = await response.text();
      
      matches = parseCSV(csvText);
      
      // Update UI
      loadingEl.style.display = 'none';
      mainContentEl.style.display = 'block';
      
      renderSite();
      initPlayerSelection(); // Init tool after data is loaded
      
    } catch (error) {
      console.error('Error fetching data:', error);
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
    }
  }

  function parseCSV(csvText) {
    const rows = csvText.split('\n').map(row => {
      // Handle CSV parsing (simple split by comma, handling quotes if necessary)
      // Since Google Sheets CSV export is reliable, we can use a regex to handle quotes
      const regex = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g;
      // Simple split usually works for simple data, but let's be safer for quotes
      let matches = [];
      let match;
      // Remove surrounding quotes if present
      const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : '';
      
      const columns = row.split(',').map(clean); 
      return columns;
    });

    // Remove Header
    const dataRows = rows.slice(1);
    
    // Group by Match (Date + Match Name)
    const matchesMap = {};

    dataRows.forEach(row => {
      if (row.length < 7) return; // Skip empty or malformed rows

      // Mapping based on your requested columns:
      // 0: Date, 1: Match, 2: Bet, 3: Winner, 4: Side, 5: Player, 6: Hero
      const date = row[0];
      const matchName = row[1]; // e.g., "ç¬¬1å ´"
      const bet = parseInt(row[2]) || 0;
      const winner = row[3].toLowerCase(); // "oda" or "united"
      const side = row[4].toLowerCase(); // "oda" or "united"
      const playerName = row[5];
      const hero = row[6];

      if (!date || !playerName) return;

      const matchKey = `${date}-${matchName}`;
      
      // Initialize match object if not exists
      if (!matchesMap[matchKey]) {
        matchesMap[matchKey] = {
          date: `${date} ${matchName}`,
          bet: bet,
          winner: winner,
          oda: [],
          united: []
        };
      }

      // Add player to correct side
      if (side === 'oda') {
        matchesMap[matchKey].oda.push({ name: playerName, hero: hero });
      } else {
        matchesMap[matchKey].united.push({ name: playerName, hero: hero });
      }

      // Collect unique player names for the tool
      allPlayers.add(playerName);
    });

    return Object.values(matchesMap);
  }

  // ==========================================
  // 2. MAIN LOGIC (RENDER)
  // ==========================================

  function renderSite() {
    // --- Stats Calculation ---
    const stats = {};
    const heroStats = {};
    const odaWins = matches.filter(m => m.winner === "oda").length;
    const unitedWins = matches.filter(m => m.winner === "united").length;
    const total = matches.length;
    
    // Faction Bars
    const odaPercent = total > 0 ? Math.round((odaWins / total) * 100) : 0;
    const unitedPercent = total > 0 ? Math.round((unitedWins / total) * 100) : 0;
    
    document.getElementById('total-matches').innerText = total;
    document.getElementById('oda-bar').style.width = odaPercent + '%';
    document.getElementById('united-bar').style.width = unitedPercent + '%';
    document.getElementById('oda-text').innerText = `ç¹”ç”°è» ${odaPercent}%`;
    document.getElementById('united-text').innerText = `è¯åˆè» ${unitedPercent}%`;

    // Process Matches
    matches.forEach(match => {
      const isOdaWin = match.winner === "oda";
      
      match.oda.forEach(p => processPlayer(p, true, isOdaWin, match.bet));
      match.united.forEach(p => processPlayer(p, false, !isOdaWin, match.bet));
    });

    function processPlayer(p, isOda, isWin, bet) {
      if (!stats[p.name]) stats[p.name] = { wins: 0, losses: 0, money: 0, heroes: [] };
      if (isWin) {
        stats[p.name].wins++;
        stats[p.name].money += bet;
      } else {
        stats[p.name].losses++;
        stats[p.name].money -= bet;
      }
      stats[p.name].heroes.push(p.hero);
      
      if (!heroStats[p.name]) heroStats[p.name] = {};
      if (!heroStats[p.name][p.hero]) heroStats[p.name][p.hero] = { wins: 0, losses: 0 };
      if (isWin) heroStats[p.name][p.hero].wins++;
      else heroStats[p.name][p.hero].losses++;
    }

    // --- Render Player Table ---
    const sortedPlayers = Object.keys(stats).map(name => {
      const p = stats[name];
      const total = p.wins + p.losses;
      const rate = total > 0 ? Math.round((p.wins / total) * 100) : 0;
      const uniqueHeroes = [...new Set(p.heroes)];
      return { name, ...p, total, rate, heroPool: uniqueHeroes.length };
    }).sort((a, b) => b.rate - a.rate || b.money - a.money);

    document.getElementById('player-overview-body').innerHTML = sortedPlayers.map(p => {
      const moneyClass = p.money >= 0 ? 'plus' : 'minus';
      const moneySign = p.money >= 0 ? '+' : '';
      const rateClass = p.rate >= 60 ? 'high' : (p.rate >= 40 ? 'mid' : 'low');
      return `<tr>
        <td><span class="player-name">${p.name}</span></td>
        <td>${p.total} <span style="opacity:0.5; font-size:11px">(${p.wins}W/${p.losses}L)</span></td>
        <td class="win-rate ${rateClass}">${p.rate}%</td>
        <td>${p.heroPool}</td>
        <td class="money ${moneyClass}">${moneySign}$${p.money}</td>
      </tr>`;
    }).join('');

    // --- Render Hero Stats ---
    document.getElementById('hero-stats-container').innerHTML = sortedPlayers.map(player => {
      const playerHeroes = heroStats[player.name];
      if (!playerHeroes) return '';
      
      const heroList = Object.entries(playerHeroes)
        .map(([hero, stats]) => {
          const total = stats.wins + stats.losses;
          const rate = total > 0 ? Math.round((stats.wins / total) * 100) : 0;
          return { hero, ...stats, total, rate };
        })
        .sort((a, b) => b.total - a.total || b.rate - a.rate);
      
      const heroItems = heroList.map(h => {
        const rateClass = h.rate >= 60 ? 'high' : (h.rate >= 40 ? 'mid' : 'low');
        return `<div class="hero-item">
          <span class="hero-name">${h.hero}</span>
          <div>
            <span class="hero-stats">${h.total}æ¬¡ (${h.wins}W-${h.losses}L)</span>
            <span class="hero-rate ${rateClass}">${h.rate}%</span>
          </div>
        </div>`;
      }).join('');
      
      return `<div class="hero-stats-card">
        <div class="hero-stats-header">${player.name}</div>
        ${heroItems}
      </div>`;
    }).join('');

    // --- Render Matches History ---
    const matchesByDate = {};
    matches.forEach(m => {
      // m.date is formatted as "2æœˆ1æ—¥ ç¬¬1å ´", extract "2æœˆ1æ—¥"
      const date = m.date.split(' ')[0];
      if (!matchesByDate[date]) matchesByDate[date] = [];
      matchesByDate[date].push(m);
    });

    document.getElementById('matches-list').innerHTML = Object.entries(matchesByDate).map(([date, dateMatches]) => {
      let inner = `<div class="date-group"><div class="date-header">${date}</div>`;
      
      dateMatches.forEach(m => {
        const matchNum = m.date.split(' ')[1] || m.date; // Fallback
        const odaClass = m.winner === "oda" ? "winner" : "loser";
        const unitedClass = m.winner === "united" ? "winner" : "loser";
        const formatPlayers = (list) => list.map(p => `<div class="match-player"><strong>${p.name}</strong><span>${p.hero}</span></div>`).join('');
        
        inner += `<div class="match-card">
          <div class="match-header">
            <span class="match-number">${matchNum}</span>
            <span class="match-bet">è³­æ³¨ $${m.bet}</span>
          </div>
          <div class="match-teams">
            <div class="team oda ${odaClass}"><div class="team-header">ç¹”ç”°è»</div>${formatPlayers(m.oda)}</div>
            <div class="team united ${unitedClass}"><div class="team-header">è¯åˆè»</div>${formatPlayers(m.united)}</div>
          </div>
        </div>`;
      });
      return inner + `</div>`;
    }).join('');

    document.getElementById('last-update').innerText = new Date().toLocaleString('zh-HK');
  }

  // ==========================================
  // 3. UI FUNCTIONS
  // ==========================================

  function switchTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    // Map tabId to index for button highlighting
    const index = tabId === 'players' ? 0 : (tabId === 'matches' ? 1 : 2);
    document.querySelectorAll('.tab')[index].classList.add('active');
    document.getElementById(`${tabId}-tab`).classList.add('active');
  }

  // --- Tools: Player Selection ---
  function initPlayerSelection() {
    const container = document.getElementById('player-selection');
    const sortedPlayers = Array.from(allPlayers).sort();
    
    container.innerHTML = sortedPlayers.map(player => `
      <div class="player-checkbox" onclick="togglePlayer(this)">
        <input type="checkbox" id="player-${player}" value="${player}">
        <label for="player-${player}">${player}</label>
      </div>
    `).join('');
  }

  function togglePlayer(element) {
    const checkbox = element.querySelector('input');
    // Prevent double toggling if clicking directly on checkbox
    if(event.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
    }
    if(checkbox.checked) element.classList.add('selected');
    else element.classList.remove('selected');
  }

  // --- Tools: Random Team Generator ---
  function randomTeams() {
    const selected = Array.from(document.querySelectorAll('#player-selection input:checked')).map(cb => cb.value);
    
    if (selected.length !== 6) {
      alert('âš ï¸ è«‹å‹™å¿…é¸æ“‡å‰›å¥½ 6 ä½ç©å®¶ï¼');
      return;
    }

    // Shuffle
    const shuffled = [...selected];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    const teamOda = shuffled.slice(0, 3);
    const teamUnited = shuffled.slice(3, 6);
    displayTeams(teamOda, teamUnited);
  }

  function displayTeams(teamOda, teamUnited) {
    const now = new Date();
    const dateStr = now.toLocaleDateString('zh-HK', { month: 'numeric', day: 'numeric' });
    const timeStr = now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' });

    // Show result container
    document.getElementById('team-result-container').style.display = 'block';

    // Inject content into the Capture Area
    const captureArea = document.getElementById('capture-area');
    captureArea.innerHTML = `
        <div class="team-display-header">âš”ï¸ å°æˆ°åˆ†çµ„çµæœ âš”ï¸</div>
        <div class="team-display-date">ğŸ“… ${dateStr} ${timeStr}</div>
        <div class="teams-grid">
          <div class="team-box oda">
            <div class="team-box-title">ğŸ”´ ç¹”ç”°è»</div>
            ${teamOda.map(p => `<div class="team-box-player">${p}</div>`).join('')}
          </div>
          <div class="team-box united">
            <div class="team-box-title">ğŸ”µ è¯åˆè»</div>
            ${teamUnited.map(p => `<div class="team-box-player">${p}</div>`).join('')}
          </div>
        </div>
    `;
    
    // Scroll to result
    setTimeout(() => {
        captureArea.scrollIntoView({ behavior: 'smooth' });
    }, 100);
  }

  // --- Tools: Capture Image ---
  function captureImage() {
    const element = document.getElementById('capture-area');
    const btn = event.target;
    const originalText = btn.innerText;
    
    btn.innerText = "â³ è™•ç†ä¸­...";
    btn.disabled = true;

    html2canvas(element, {
      backgroundColor: '#111827', // Match card background
      scale: 3, // High resolution
      logging: false,
      useCORS: true
    }).then(canvas => {
      // Create download link
      const link = document.createElement('a');
      link.download = `ä¿¡é•·åˆ†éšŠ_${new Date().getTime()}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
      
      btn.innerText = originalText;
      btn.disabled = false;
    }).catch(err => {
      console.error(err);
      alert("æˆªåœ–å¤±æ•—ï¼Œè«‹é‡è©¦");
      btn.innerText = originalText;
      btn.disabled = false;
    });
  }

  // --- Initialize ---
  // Start loading data when page is ready
  document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
